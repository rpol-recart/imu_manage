# **Техническая документация модуля `position_estimator`**

---

## **1. Общее описание**

Модуль `position_estimator` предназначен для обработки данных от **GPS- и IMU-датчиков**, выполнения **фьюжна (объединения)** этих данных, оценки текущего положения и ориентации транспортного средства (ТС), а также управления состоянием системы позиционирования.

Модуль реализует **мультисенсорную фильтрацию**, **прогнозирование состояния**, **оценку достоверности позиции**, **управление состоянием**, **фоновые процессы** и **калибровку датчиков**. Поддерживает работу в различных режимах в зависимости от доступности сенсоров и их качества.

---

## **2. Архитектурные принципы**

Модуль разработан в соответствии с принципами **SOLID**:

| Принцип | Реализация |
|--------|------------|
| **SRP (Single Responsibility Principle)** | Каждый класс отвечает за одну зону ответственности (например, `SensorDataManager` — отслеживание активности датчиков, `PositionFuser` — фьюжн данных). |
| **OCP (Open/Closed Principle)** | Расширяемость через интерфейсы (`StateCalculator`, `ConfidenceCalculator`) и инъекцию зависимостей. |
| **LSP (Liskov Substitution Principle)** | Все реализации протоколов взаимозаменяемы (например, можно подставить другой `TimerManager`). |
| **ISP (Interface Segregation Principle)** | Интерфейсы разделены по функциональности (нет "толстых" интерфейсов). |
| **DIP (Dependency Inversion Principle)** | Модуль зависит от абстракций (протоколов), а не от конкретных реализаций. |

---


## **4. Основные классы и компоненты**

### **4.1. `PositionEstimator` — основной класс модуля**

**Назначение:** Центральный класс, управляющий всем процессом позиционирования.

#### **Основные функции:**
- Приём данных от GPS и IMU.
- Обновление состояния модуля.
- Оценка текущей позиции (с фьюжном и прогнозированием).
- Управление фоновыми процессами.
- Сохранение состояния при остановке.

#### **Конструктор:**
```python
def __init__(
    self,
    config_path: str,
    state_calculator: Optional[StateCalculator] = None,
    confidence_calculator: Optional[ConfidenceCalculator] = None,
    timer_manager: Optional[TimerManager] = None
)
```

| Параметр | Описание |
|---------|--------|
| `config_path` | Путь к конфигурационному файлу |
| `state_calculator` | Кастомный калькулятор состояния (по умолчанию `DefaultStateCalculator`) |
| `confidence_calculator` | Кастомный калькулятор достоверности (по умолчанию `DefaultConfidenceCalculator`) |
| `timer_manager` | Менеджер таймеров (по умолчанию `DefaultTimerManager`) |

#### **Публичные методы:**

| Метод | Описание |
|------|--------|
| `update_gps(sensor_id, timestamp, lat, lon, alt)` | Приём данных от GPS-датчика |
| `update_imu(imu_data)` | Приём данных от IMU-датчика |
| `get_current_state(target_timestamp=None, force_update=False)` | Получение текущего состояния ТС |
| `start_magnetometer_calibration(duration_sec=120)` | Запуск калибровки магнитометра |
| `get_history_stats()` | Получение статистики по данным |
| `stop()` | Корректная остановка модуля |

---

### **4.2. `ModuleState` — состояния модуля**

| Состояние | Описание |
|----------|--------|
| `BOOTING` | Инициализация модуля |
| `READY` | Готов к работе |
| `GPS_IMU_FUSION` | Работа в режиме фьюжна GPS и IMU |
| `IMU_DEAD_RECKONING` | Только IMU (после потери GPS) |
| `GPS_ONLY` | Только GPS (без IMU) |
| `STANDBY` | Ожидание активности |
| `CALIBRATING_MAG` | Калибровка магнитометра |
| `POWER_OFF` | Выключен |
| `DEGRADED` | Деградированное состояние (нет данных) |

---

### **4.3. `VehicleStatus` — статус транспортного средства**

| Статус | Описание |
|-------|--------|
| `OFF` | ТС неактивно |
| `STANDBY` | ТС стоит, но система активна |
| `RUNNING` | ТС в движении |

---

### **4.4. `PositionState` — выходное состояние позиции**

| Поле | Тип | Описание |
|------|-----|--------|
| `lat` | float | Широта (WGS84) |
| `lon` | float | Долгота (WGS84) |
| `alt` | float | Высота (м) |
| `azimuth` | float | Азимут (градусы, 0° — север) |
| `timestamp` | int | Временная метка (мс, Unix time) |
| `confidence` | float | Достоверность (0.0–1.0) |
| `status` | str | Текущее состояние модуля |
| `source` | str | Источник данных (`gps_dual`, `gps_1`, `none`) |
| `vehicle_status` | str | Статус ТС (`off`, `standby`, `running`) |

---

### **4.5. `SensorDataManager` — менеджер данных датчиков**

**Назначение:** Отслеживание активности GPS и IMU.

#### **Функции:**
- Обновление временных меток датчиков.
- Определение активных GPS-датчиков.
- Хранение времени последнего обновления.

---

### **4.6. `VehicleStatusCalculator` — калькулятор статуса ТС**

**Назначение:** Определение, движется ли ТС, на основе данных IMU и GPS.

#### **Логика:**
- Если прошло > `inactivity_timeout_to_off_sec` — `OFF`.
- Если прошло > `inactivity_timeout_to_standby_sec` — `STANDBY`.
- Иначе: если `is_vehicle_moving()` — `RUNNING`, иначе `STANDBY`.

---

### **4.7. `CalibrationService` — сервис калибровки**

**Назначение:** Управление калибровкой датчиков.

#### **Поддерживаемые калибровки:**
- **Автоматическая калибровка гироскопа**: при неподвижности ТС, периодически (настраивается).
- **Ручная калибровка магнитометра**: требует вращения ТС в течение заданного времени.

---

### **4.8. `DefaultStateCalculator` — калькулятор состояния**

**Назначение:** Определение текущего состояния модуля.

#### **Правила перехода:**
| Условие | Состояние |
|--------|----------|
| Есть GPS и IMU | `GPS_IMU_FUSION` |
| Только IMU | `IMU_DEAD_RECKONING` |
| Только GPS | `GPS_ONLY` |
| Нет данных > 2 мин | `DEGRADED` |
| Нет данных, но недавно было | `STANDBY` |

---

### **4.9. `DefaultConfidenceCalculator` — калькулятор достоверности**

**Назначение:** Оценка уверенности в позиции.

#### **Базовые значения:**
| Состояние | Базовая достоверность |
|----------|------------------|
| `GPS_IMU_FUSION` | 0.95 (снижается со временем) |
| `IMU_DEAD_RECKONING` | 0.70 (быстро снижается) |
| `GPS_ONLY` | 0.80 (зависит от количества активных GPS) |
| `STANDBY` | 0.85 |
| `DEGRADED` | 0.0 |

---

### **4.10. `DefaultTimerManager` — менеджер таймеров**

**Назначение:** Запуск фоновых задач.

#### **Задачи:**
- Очистка старых данных из БД (каждые 5 минут).
- Автоматическая калибровка гироскопа (периодически).
- Калибровка магнитометра (по запросу).

---

## **5. Взаимодействие с внешними компонентами**

| Компонент | Назначение |
|---------|----------|
| `GPSDataHandler` | Обработка и валидация GPS-данных |
| `IMUDataHandler` | Обработка данных акселерометра, гироскопа, магнитометра |
| `PositionFuser` | Фьюжн данных GPS и IMU (например, через фильтр Калмана) |
| `StatePredictor` | Прогнозирование положения при экстраполяции |
| `DatabaseManager` | Хранение сырых данных, состояния, статистики |
| `LoggerService` | Логирование событий и ошибок |

---

## **6. Жизненный цикл модуля**

### **Инициализация:**
1. Загрузка конфигурации.
2. Восстановление состояния из БД.
3. Запуск фоновых процессов (калибровка, очистка).
4. Установка состояния `BOOTING → READY`.

### **Работа:**
- Приём данных от GPS/IMU → обновление состояния.
- Обработка → фьюжн → сохранение в БД.
- При запросе — возврат `PositionState`.

### **Остановка:**
1. Остановка всех таймеров.
2. Сохранение текущего состояния в БД.
3. Закрытие соединения с БД.

---

## **7. Безопасность и надёжность**

- **Потокобезопасность:** Все методы используют `threading.RLock`.
- **Обработка ошибок:** Все внешние вызовы обёрнуты в `try-except`.
- **Восстановление после сбоев:** Состояние сохраняется в БД.
- **Валидация данных:** Проверка статуса IMU, корректность координат.


---

## **9. Пример использования**

```python
from position_estimator import PositionEstimator

# Инициализация
estimator = PositionEstimator("config.yaml")

# Приём GPS данных
estimator.update_gps(sensor_id=1, timestamp=1712345678000,
                     lat=55.7558, lon=37.6176, alt=150.0)

# Приём IMU данных
estimator.update_imu({
    "timestamp": 1712345678010,
    "accelerometer": {"x": 0.1, "y": -0.05, "z": 9.8},
    "gyroscope": {"x": 0.0, "y": 0.0, "z": 0.0},
    "magnetometer": {"x": 25.0, "y": -10.0, "z": 40.0},
    "temperature": 30.0,
    "status": "ok"
})

# Получение текущего состояния
state = estimator.get_current_state()
print(f"Lat: {state.lat}, Lon: {state.lon}, Confidence: {state.confidence}")

# Остановка
estimator.stop()
```

---

## **10. Расширение и кастомизация**

Модуль поддерживает инъекцию зависимостей:

```python
class CustomStateCalculator:
    def calculate_state(self, has_gps, has_imu, ...):
        # Кастомная логика
        return ModuleState.GPS_IMU_FUSION

estimator = PositionEstimator(
    config_path="config.yaml",
    state_calculator=CustomStateCalculator(),
    confidence_calculator=CustomConfidenceCalculator()
)
```

---

## **11. Диагностика и мониторинг**

- **Логирование:** Все операции логируются через `LoggerService`.
- **Статистика:** `get_history_stats()` возвращает:
  - Количество GPS/IMU записей.
  - Состояние модуля.
  - Активные датчики.
  - Статус ТС.

---

## **12. Возможные улучшения**

- Поддержка **фильтра Калмана** в `PositionFuser`.
- Добавление **NMEA-парсера** для сырых GPS-данных.
- Интеграция с **CAN-шиной** для получения данных о скорости.
- Поддержка **RTK-GPS** для высокоточного позиционирования.
- Визуализация траектории (через API).

---

## **13. Зависимости**

- Python 3.8+
- `threading`, `abc`, `dataclasses`, `typing`
- Внешние модули:
  - `database_manager`
  - `gps_data_handler`
  - `imu_data_handler`
  - `position_fuser`
  - `state_predictor`
  - `logger_service`



**Дата последнего обновления документации:** 05.04.2025  
**Статус:** Готово к использованию
