# **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `database_manager.py`**

---

## **–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ**

–ú–æ–¥—É–ª—å `DatabaseManager` ‚Äî —ç—Ç–æ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–ø–∏—Å—å—é –∏ —á—Ç–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö —Å–µ–Ω—Å–æ—Ä–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–æ–≤ (GPS, IMU –∏ –¥—Ä.) —Å –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–µ–π –∏ –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å—å—é.
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–¥—É–ª—è.
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ —Ñ—É–∑–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–∏).
- –û—á–∏—Å—Ç–∫—É —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è.
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –¥–∞–Ω–Ω—ã–º.

–ú–æ–¥—É–ª—å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–∞—Ö —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –≥–¥–µ –≤–∞–∂–Ω—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

---

## **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã**

### **–ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –ø–æ–¥—Ö–æ–¥—ã**
- **–û–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–∞—è –∑–∞–ø–∏—Å—å**: –í—Å–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ (`_writer_worker`) –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞.
- **–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è**: –î–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ –±—É—Ñ–µ—Ä (–ø–∞–∫–µ—Ç), –∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ë–î –ø–∞–∫–µ—Ç–Ω–æ, —á—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
- **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `threading.RLock` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é —Å –ë–î –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏ –∑–∞–ø–∏—Å–∏.
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å**: –î–∞–Ω–Ω—ã–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ `queue.Queue`, –æ—Ç–∫—É–¥–∞ —Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –∏—Ö –∑–∞–±–∏—Ä–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç.

---

## **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**

| –ú–æ–¥—É–ª—å | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|-----------|
| `sqlite3` | –†–∞–±–æ—Ç–∞ —Å SQLite –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö |
| `threading` | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ–Ω–æ–≤—ã–º –ø–æ—Ç–æ–∫–æ–º –∑–∞–ø–∏—Å–∏ |
| `queue.Queue` | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏ |
| `json` | –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö |
| `os`, `time` | –†–∞–±–æ—Ç–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π |
| `logging` | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π |
| `typing` | –¢–∏–ø–∏–∑–∞—Ü–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ IDE –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤) |
| `ConfigProvider` | –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ |
| `LoggerService` | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |

---

## **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—á–µ—Ä–µ–∑ `ConfigProvider`)**

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ConfigProvider` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫. –û–∂–∏–¥–∞–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```python
data:
  database:
    path: "/path/to/sensor_data.db"
    batch_size: 100
    batch_timeout: 5
  gps:
    history_window_ms: 5000
```

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|--------|-------|
| `database.path` | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É SQLite –ë–î | `/data/sensors.db` |
| `database.batch_size` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ | `100` |
| `database.batch_timeout` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é (—Å–µ–∫) | `5` |
| `gps.history_window_ms` | –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–∞ GPS-–¥–∞–Ω–Ω—ã—Ö (–º—Å) | `5000` |

> ‚ö†Ô∏è –ï—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤ `path` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, SQLite –Ω–µ —Å–æ–∑–¥–∞—Å—Ç –µ—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—É—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.

---

## **–ö–ª–∞—Å—Å: `DatabaseManager`**

### **–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä: `__init__(config)`**

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –ë–î: —Å–æ–∑–¥–∞—ë—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î, –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –∑–∞–ø–∏—Å–∏.

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|--------|
| `config` | `ConfigProvider` | –û–±—ä–µ–∫—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ |

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –°–æ–∑–¥–∞—ë—Ç –ª–æ–≥–≥–µ—Ä.
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–±–ª–∏—Ü—ã, –∏–Ω–¥–µ–∫—Å—ã).
3. –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ `_writer_worker`.

---

## **–¢–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**

### 1. `sensor_data`
–•—Ä–∞–Ω–∏—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –¥–∞—Ç—á–∏–∫–æ–≤.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|--------|
| `id` | INTEGER PRIMARY KEY AUTOINCREMENT | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø–∏—Å–∏ |
| `timestamp` | INTEGER | –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ (Unix –≤—Ä–µ–º—è, –º—Å) |
| `sensor_type` | TEXT | –¢–∏–ø –¥–∞—Ç—á–∏–∫–∞: `'gps'`, `'imu_raw'`, `'orientation'` |
| `sensor_id` | INTEGER | ID –¥–∞—Ç—á–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, GPS1=1, GPS2=2) |
| `data_json` | TEXT | –î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON |
| `created_at` | INTEGER | –í—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ë–î (–º—Å) |

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_sensor_data_timestamp` ‚Äî –ø–æ `timestamp`
- `idx_sensor_data_type` ‚Äî –ø–æ `sensor_type`

---

### 2. `calibration`
–•—Ä–∞–Ω–∏—Ç –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–∞—Ç—á–∏–∫–æ–≤.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|--------|
| `id` | INTEGER PRIMARY KEY | ID (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) |
| `sensor_name` | TEXT | –ò–º—è –¥–∞—Ç—á–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `'imu_acc_bias'`) |
| `parameters_json` | TEXT | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ –≤ JSON |
| `date_calibrated` | INTEGER | –í—Ä–µ–º—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ (Unix, –º—Å) |

**–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å:** `sensor_name`

---

### 3. `module_state`
–•—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥—É–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π timestamp, —Ñ–ª–∞–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏).

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|--------|
| `id` | INTEGER PRIMARY KEY CHECK (id = 1) | –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ |
| `state_json` | TEXT | –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤ JSON |
| `saved_at` | INTEGER | –í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–º—Å) |

> ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å (`id=1`), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `INSERT OR REPLACE`.

---

## **–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã**

### **1. `save_sensor_data(timestamp, sensor_type, sensor_id, data_json_str)`**

–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å –¥–∞—Ç—á–∏–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ –∑–∞–ø–∏—Å—å.

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|--------|
| `timestamp` | `int` | –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ (Unix, –º—Å) |
| `sensor_type` | `str` | –¢–∏–ø –¥–∞—Ç—á–∏–∫–∞ |
| `sensor_id` | `int or None` | ID –¥–∞—Ç—á–∏–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| `data_json_str` | `str` | –î–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ JSON-—Å—Ç—Ä–æ–∫–∏ |

**–ü—Ä–∏–º–µ—Ä:**
```python
db_manager.save_sensor_data(
    timestamp=1712345678901,
    sensor_type="gps",
    sensor_id=1,
    data_json_str='{"lat": 55.7558, "lon": 37.6176}'
)
```

> üîî –î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ ‚Äî –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ—á–µ—Ä–µ–¥—å, –∑–∞–ø–∏—Å—å –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –≤ —Ñ–æ–Ω–µ.

---

### **2. `save_calibration(sensor_name, parameters, date_calibrated=None)`**

–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|--------|
| `sensor_name` | `str` | –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `'gps_antenna_offset'`) |
| `parameters` | `dict` | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ |
| `date_calibrated` | `int` | –í—Ä–µ–º—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏ (–º—Å), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Ç–µ–∫—É—â–µ–µ |

**–ü—Ä–∏–º–µ—Ä:**
```python
db_manager.save_calibration(
    sensor_name="imu_gyro_bias",
    parameters={"x": 0.001, "y": -0.002, "z": 0.0005}
)
```

---

### **3. `get_calibration(sensor_name)` ‚Üí `Optional[Dict]`**

–ü–æ–ª—É—á–∞–µ—Ç –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ –∏–º–µ–Ω–∏.

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|--------|
| `sensor_name` | `str` | –ò–º—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ |

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `dict` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã.
- `None` ‚Äî –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.

**–ü—Ä–∏–º–µ—Ä:**
```python
params = db_manager.get_calibration("imu_gyro_bias")
if params:
    print(params["x"])
```

---

### **4. `get_data_for_time(target_timestamp, window_ms=1000)` ‚Üí `Dict[str, Any]`**

–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–æ–∫—Ä—É–≥ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ñ—É–∑–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –∞–ª–≥–æ—Ä–∏—Ç–º–µ —Ñ–∏–ª—å—Ç—Ä–∞ –ö–∞–ª–º–∞–Ω–∞).

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|--------|
| `target_timestamp` | `int` | –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è (–º—Å) |
| `window_ms` | `int` | –®–∏—Ä–∏–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞ (–º—Å) |

**–õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∫–∏:**
- GPS: –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ `history_window_ms` –¥–æ `target_timestamp + window_ms/2`, –¥–æ 15 –∑–∞–ø–∏—Å–µ–π –Ω–∞ –¥–∞—Ç—á–∏–∫.
- IMU: –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å (`imu_raw` –∏–ª–∏ `orientation`) –≤ –æ–∫–Ω–µ.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
{
    "gps": [
        {
            "timestamp": 1712345678000,
            "sensor_id": 1,
            "data": {"lat": 55.7558, "lon": 37.6176}
        },
        ...
    ],
    "imu": {
        "timestamp": 1712345678900,
        "type": "imu_raw",
        "data": {"ax": 0.1, "ay": 0.2, "az": 9.8}
    }
}
```

> ‚ö†Ô∏è –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö JSON-–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è, –Ω–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è.

---

### **5. `save_state(state_data)`**

–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥—É–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö).

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|--------|
| `state_data` | `dict` | –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è |

**–ü—Ä–∏–º–µ—Ä:**
```python
db_manager.save_state({
    "last_processed_gps_time": 1712345678000,
    "fusion_status": "active"
})
```

---

### **6. `get_last_state()` ‚Üí `Optional[Dict]`**

–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- `dict` ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å.
- `None` ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç.

---

### **7. `cleanup_old_data(retention_minutes)`**

–£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ `sensor_data` (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤).

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|--------|
| `retention_minutes` | `int` | –í—Ä–µ–º—è —Ö—Ä–∞–Ω–µ–Ω–∏—è (–≤ –º–∏–Ω—É—Ç–∞—Ö) |

**–ü—Ä–∏–º–µ—Ä:**
```python
db_manager.cleanup_old_data(60 * 24)  # –£–¥–∞–ª–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
```

---

### **8. `get_data_statistics()` ‚Üí `Dict[str, Any]`**

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –¥–∞–Ω–Ω—ã–º –≤ –ë–î.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```python
{
    "total_records": 15000,
    "last_update_timestamp": 1712345678901,
    "records_by_type": {
        "gps": 10000,
        "imu_raw": 5000
    },
    "gps_records_by_id": {
        1: 6000,
        2: 4000
    },
    "last_calibration": {
        "sensor_name": "imu_gyro_bias",
        "date_calibrated": 1712345000000
    }
}
```

---

### **9. `close()`**

–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã.

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.**

---

## **–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ç–æ–¥—ã**

### **`_init_database()`**
–°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã –∏ –∏–Ω–¥–µ–∫—Å—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç.

### **`_writer_worker()`**
–§–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫:
- –ß–∏—Ç–∞–µ—Ç –∏–∑ `Queue` —Å —Ç–∞–π–º–∞—É—Ç–æ–º 0.1 —Å.
- –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ `batch`.
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ø–∞–∫–µ—Ç, –µ—Å–ª–∏:
  - –ù–∞–±—Ä–∞–Ω–æ `batch_size` –∑–∞–ø–∏—Å–µ–π.
  - –ü—Ä–æ—à–ª–æ `batch_timeout_sec` —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏.
- –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏.

### **`_write_batch(batch)`**
–í—ã–ø–æ–ª–Ω—è–µ—Ç `INSERT INTO sensor_data` —á–µ—Ä–µ–∑ `executemany`.

### **`_get_connection()`**
–°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å `check_same_thread=False`, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ.

---

## **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å**

| –ê—Å–ø–µ–∫—Ç | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è |
|-------|-----------|
| **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | `RLock`, `Queue`, `daemon=True` |
| **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** | –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ `try-except`, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |
| **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** | –í—Å–µ –∑–∞–ø–∏—Å–∏ ‚Äî –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ |
| **–û—à–∏–±–∫–∏ JSON** | –õ–æ–≥–∏—Ä—É—é—Ç—Å—è, –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è |
| **–û—à–∏–±–∫–∏ –ë–î** | –õ–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç —Ä–∞–±–æ—Ç—É |

> ‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ**: –ü—Ä–∏ —Å–±–æ–µ –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª–Ω—ã–π –¥–∏—Å–∫) –¥–∞–Ω–Ω—ã–µ –≤ –æ—á–µ—Ä–µ–¥–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã. –î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–∏—Å—Ç–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å fallback (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª).

---

## **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `LoggerService`. –£—Ä–æ–≤–Ω–∏:

- `INFO` ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
- `DEBUG` ‚Äî –¥–µ—Ç–∞–ª–∏ –∑–∞–ø–∏—Å–∏, –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.
- `ERROR` ‚Äî –æ—à–∏–±–∫–∏ –ë–î, JSON, –ø–æ—Ç–æ–∫–æ–≤.

---

## **–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

```python
from database_manager import DatabaseManager
from config import ConfigProvider

config = ConfigProvider.load("config.yaml")
db_manager = DatabaseManager(config)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
db_manager.save_sensor_data(
    timestamp=int(time.time() * 1000),
    sensor_type="gps",
    sensor_id=1,
    data_json_str=json.dumps({"lat": 55.7558, "lon": 37.6176})
)

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ—É–∑–∏–∏
data = db_manager.get_data_for_time(1712345678000)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
db_manager.save_calibration("imu_bias", {"x": 0.01, "y": -0.01})

# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
db_manager.close()
```

---

## **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é**

1. **–ù–µ –≤—ã–∑—ã–≤–∞–π—Ç–µ `close()` –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.**
2. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ë–î.**
3. **–†–µ–≥—É–ª—è—Ä–Ω–æ –≤—ã–∑—ã–≤–∞–π—Ç–µ `cleanup_old_data()` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ —Ç–∞–π–º–µ—Ä—É).**
4. **–î–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–ª–∏—á—å—Ç–µ `batch_size` (–¥–æ 500‚Äì1000).**
5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `get_data_statistics()` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.**

---

## **–í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**

| –£–ª—É—á—à–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|--------|
| **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î** | –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ `.db` —Ñ–∞–π–ª–∞ |
| **–†–æ—Ç–∞—Ü–∏—è –ë–î** | –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ –¥–∞—Ç–µ |
| **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö –ë–î** | PostgreSQL, InfluxDB |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è JSON** | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤ –æ—á–µ—Ä–µ–¥—å |
| **–ú–µ—Ç—Ä–∏–∫–∏ (Prometheus)** | –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ |
| **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏** | –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞–ø–∏—Å–∏ ‚Äî –ø–æ–≤—Ç–æ—Ä –ø–æ–ø—ã—Ç–∫–∏ |

---

## **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

–ú–æ–¥—É–ª—å `DatabaseManager` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ–µ, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–æ–≤. –û–Ω –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Å–∏—Å—Ç–µ–º —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –≥–¥–µ –≤–∞–∂–Ω—ã –Ω–∏–∑–∫–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å.

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω —Å —É—á—ë—Ç–æ–º:
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å).
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å).
- –ü—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—É–¥–æ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã API).
- –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏ (–ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö).

--- 

**–ê–≤—Ç–æ—Ä:** –°–∏—Å—Ç–µ–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏  
**–î–∞—Ç–∞:** 2025-04-05  
**–í–µ—Ä—Å–∏—è –º–æ–¥—É–ª—è:** 1.0