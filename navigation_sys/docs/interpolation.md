# Техническая документация модуля `interpolation.py`

---

## Общее описание

Модуль `interpolation.py` предоставляет набор утилит для выполнения интерполяции данных, как скалярных, так и угловых (включая ориентации в виде кватернионов). Основное назначение модуля — обеспечение точной и эффективной интерполяции значений в различных контекстах: от простых линейных зависимостей до сложных сферических интерполяций (SLERP), используемых в робототехнике, анимации, навигации и системах ориентации.

Модуль оптимизирован для производительности и устойчивости к ошибкам округления, включая проверки граничных случаев и защиту от деления на ноль.

---

## Импорты и зависимости

```python
import math
from typing import Tuple, Optional, list
```

- `math` — для математических операций (`sin`, `cos`, `acos`, `sqrt` и т.д.).
- `typing` — аннотации типов для улучшения читаемости и поддержки статической проверки типов.

---

## Глобальные константы

| Константа | Значение | Назначение |
|----------|---------|-----------|
| `_EPSILON` | `1e-10` | Порог для сравнения чисел с плавающей точкой (защита от деления на ноль, проверка нормы и т.д.). |
| `_SLERP_THRESHOLD` | `0.9995` | Порог для перехода от SLERP к линейной интерполяции при близости кватернионов (для стабильности). |
| `_TWO_PI` | `2 * math.pi` | Удвоенное значение π, используется для нормализации углов. |
| `_PI` | `math.pi` | Значение π, используется в нормализации и проверке диапазонов. |

---

## Функции

---

### 1. `linear_interpolate`

#### Назначение
Выполняет линейную интерполяцию между двумя точками `(x0, y0)` и `(x1, y1)` для заданного значения `x`.

#### Сигнатура
```python
def linear_interpolate(
    x0: float,
    y0: float,
    x1: float,
    y1: float,
    x: float
) -> Optional[float]
```

#### Параметры
| Параметр | Тип | Описание |
|--------|-----|---------|
| `x0` | `float` | X-координата первой точки. |
| `y0` | `float` | Y-координата первой точки. |
| `x1` | `float` | X-координата второй точки. |
| `y1` | `float` | Y-координата второй точки. |
| `x`  | `float` | X-значение, для которого требуется интерполяция. |

#### Возвращаемое значение
- `float`: Интерполированное значение `y`, рассчитанное по формуле:  
  \[
  y = y_0 + (y_1 - y_0) \cdot \frac{x - x_0}{x_1 - x_0}
  \]
- `None`: Если:
  - `x0 ≈ x1` (точки совпадают по X),
  - `x` лежит вне отрезка `[x0, x1]` (с учётом погрешности `_EPSILON`).

#### Пример
```python
y = linear_interpolate(0.0, 0.0, 2.0, 4.0, 1.0)  # Вернёт 2.0
```

#### Особенности
- Проверка на совпадение `x0` и `x1` через `_EPSILON`.
- Проверка выхода `x` за пределы интервала: `(x - x0) * (x - x1) > _EPSILON` — означает, что `x` вне диапазона.

---

### 2. `_normalize_quaternion_fast`

#### Назначение
Быстрая нормализация кватерниона. Проверяет, нормализован ли кватернион, и при необходимости выполняет нормализацию.

#### Сигнатура
```python
def _normalize_quaternion_fast(
    q: Tuple[float, float, float, float]
) -> Tuple[float, float, float, float]
```

#### Параметры
| Параметр | Тип | Описание |
|--------|-----|---------|
| `q` | `Tuple[float, float, float, float]` | Кватернион в формате `(w, x, y, z)`. |

#### Возвращаемое значение
- Нормализованный кватернион `(w, x, y, z)`.

#### Исключения
- `ValueError`: Если норма кватерниона близка к нулю (невозможно нормализовать).

#### Логика
- Если норма квадрата кватерниона `≈ 1` — возвращается исходный кватернион.
- Если норма `≈ 0` — выбрасывается ошибка.
- Иначе: деление компонент на длину вектора.

---

### 3. `_dot_product_quaternion`

#### Назначение
Вычисляет скалярное произведение двух кватернионов.

#### Сигнатура
```python
def _dot_product_quaternion(
    q0: Tuple[float, float, float, float],
    q1: Tuple[float, float, float, float]
) -> float
```

#### Параметры
| Параметр | Тип | Описание |
|--------|-----|---------|
| `q0`, `q1` | `Tuple[float, ...]` | Два кватерниона `(w, x, y, z)`. |

#### Возвращаемое значение
- `float`: Скалярное произведение:  
  \[
  q0 \cdot q1 = w_0 w_1 + x_0 x_1 + y_0 y_1 + z_0 z_1
  \]

#### Применение
Используется в SLERP для определения угла между кватернионами.

---

### 4. `slerp`

#### Назначение
Выполняет **сферическую линейную интерполяцию (SLERP)** между двумя кватернионами. Обеспечивает плавное вращение по кратчайшему пути на сфере.

#### Сигнатура
```python
def slerp(
    q0: Tuple[float, float, float, float],
    q1: Tuple[float, float, float, float],
    t: float
) -> Tuple[float, float, float, float]
```

#### Параметры
| Параметр | Тип | Описание |
|--------|-----|---------|
| `q0` | `Tuple[float, ...]` | Начальный кватернион `(w, x, y, z)`. |
| `q1` | `Tuple[float, ...]` | Конечный кватернион `(w, x, y, z)`. |
| `t`  | `float` | Параметр интерполяции: `0 ≤ t ≤ 1`. При `t=0` — `q0`, при `t=1` — `q1`. |

#### Возвращаемое значение
- Интерполированный кватернион `(w, x, y, z)`.

#### Исключения
- `ValueError`: Если `t < 0` или `t > 1`, или если один из кватернионов нулевой.

#### Алгоритм
1. **Граничные случаи**: если `t == 0` или `t == 1` — возвращается нормализованный `q0` или `q1`.
2. **Нормализация** обоих кватернионов.
3. **Скалярное произведение** `dot`. Если `dot < 0`, инвертируется `q1` для выбора кратчайшего пути.
4. **Ограничение `dot` до 1.0** (защита от ошибок округления).
5. **Близкие кватернионы** (`dot > 0.9995`): используется линейная интерполяция (LERP) + нормализация.
6. **Общий случай SLERP**:
   \[
   q(t) = \frac{\sin((1-t)\theta)}{\sin \theta} q_0 + \frac{\sin(t\theta)}{\sin \theta} q_1
   \]
   где \(\theta = \arccos(\text{dot})\).

7. **Резервный случай**: если `sin(theta)` близок к нулю — используется LERP.

#### Пример
```python
q_interpolated = slerp((1, 0, 0, 0), (0, 1, 0, 0), 0.5)
```

---

### 5. `_normalize_angle_fast`

#### Назначение
Нормализует угол в радианах в диапазон \([-π, π]\).

#### Сигнатура
```python
def _normalize_angle_fast(angle: float) -> float
```

#### Параметры
| Параметр | Тип | Описание |
|--------|-----|---------|
| `angle` | `float` | Угол в радианах. |

#### Возвращаемое значение
- Угол, приведённый к диапазону \([-π, π]\).

#### Логика
- Если угол уже в диапазоне — возвращается без изменений.
- Иначе: приводится к \([0, 2π]\) через `%`, затем — к \([-π, π]\).

#### Пример
```python
_normalize_angle_fast(3.5 * math.pi)  # Вернёт ≈ -0.5π
```

---

### 6. `slerp_angle`

#### Назначение
Выполняет интерполяцию между двумя углами (в радианах) по кратчайшему пути на окружности (аналог SLERP для 2D).

#### Сигнатура
```python
def slerp_angle(
    angle0_rad: float,
    angle1_rad: float,
    t: float
) -> float
```

#### Параметры
| Параметр | Тип | Описание |
|--------|-----|---------|
| `angle0_rad` | `float` | Начальный угол (радианы). |
| `angle1_rad` | `float` | Конечный угол (радианы). |
| `t` | `float` | Параметр интерполяции: `0 ≤ t ≤ 1`. |

#### Возвращаемое значение
- Интерполированный угол в радианах, нормализованный в \([-π, π]\).

#### Исключения
- `ValueError`: если `t` вне диапазона `[0, 1]`.

#### Алгоритм
1. Нормализация обоих углов.
2. Вычисление разности с учётом "перехода через 0":
   - Если разность > π — вычитаем \(2π\).
   - Если < -π — прибавляем \(2π\).
3. Интерполяция: `angle0 + t * diff`.
4. Нормализация результата.

#### Пример
```python
result = slerp_angle(math.pi/2, -math.pi/2, 0.5)  # Вернёт 0.0 (через верх)
```

---

### 7. `linear_interpolate_batch`

#### Назначение
Выполняет пакетную линейную интерполяцию для нескольких значений `x` по заданному набору точек.

#### Сигнатура
```python
def linear_interpolate_batch(
    points: list[Tuple[float, float]],
    x_values: list[float]
) -> list[Optional[float]]
```

#### Параметры
| Параметр | Тип | Описание |
|--------|-----|---------|
| `points` | `list[Tuple[float, float]]` | Список точек `(x, y)` для построения ломаной. |
| `x_values` | `list[float]` | Список X-значений, для которых нужно вычислить Y. |

#### Возвращаемое значение
- `list[Optional[float]]`: Список интерполированных значений.  
  `None` — если точка `x` не попадает ни в один интервал или данных недостаточно.

#### Логика
1. Сортировка точек по возрастанию `x`.
2. Для каждого `x` в `x_values`:
   - Поиск первого интервала `[x_i, x_{i+1}]`, в который попадает `x`.
   - Применение `linear_interpolate` на этом интервале.
3. Если интервал не найден — возвращается `None`.

#### Пример
```python
points = [(0, 0), (1, 2), (3, 6)]
x_vals = [0.5, 2.0, 4.0]
results = linear_interpolate_batch(points, x_vals)
# Результат: [1.0, 4.0, None]
```

#### Особенности
- Поддерживает произвольное количество точек.
- Интерполяция выполняется по кусочно-линейной ломаной.
- Не экстраполирует за пределы диапазона `x`.

---

## Общие особенности и оптимизации

- **Производительность**:
  - Использование `_EPSILON` вместо прямого сравнения с нулём.
  - Проверки на граничные значения (`t == 0`, `t == 1`) для быстрого выхода.
  - Избегание лишних вычислений (например, нормализация только при необходимости).
- **Устойчивость**:
  - Обработка случаев близких кватернионов через LERP.
  - Ограничение `dot` до 1.0 перед `acos`.
  - Защита от деления на ноль.
- **Типизация**:
  - Полная аннотация типов для поддержки `mypy`, IDE и документации.

---

## Примеры использования

### 1. Интерполяция координат
```python
x_interp = linear_interpolate(0, 10, 5, 20, 2.5)  # → 15.0
```

### 2. Интерполяция ориентации (кватернион)
```python
q_start = (1, 0, 0, 0)
q_end = (0.707, 0.707, 0, 0)
q_mid = slerp(q_start, q_end, 0.5)
```

### 3. Интерполяция угла
```python
angle = slerp_angle(math.pi, -math.pi/2, 0.3)  # Плавный переход с учётом направления
```

### 4. Пакетная интерполяция
```python
trajectory = [(0, 0), (1, 1), (2, 0)]
times = [0.5, 1.5, 3.0]
positions = linear_interpolate_batch(trajectory, times)  # [0.5, 0.5, None]
```

---

## Возможные улучшения (TODO)

- Добавить поддержку интерполяции с экстраполяцией (через параметр).
- Реализовать кубическую интерполяцию (например, Catmull-Rom).
- Добавить векторизованные версии функций (например, через `numpy`).
- Поддержка интерполяции по времени с заданной скоростью.
